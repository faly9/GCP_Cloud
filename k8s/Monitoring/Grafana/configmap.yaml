apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  django-dashboard.json: |
    {
      "title": "Surveillance Django",
      "uid": "django-dashboard",
      "schemaVersion": 30,
      "panels": [
        {
          "type": "timeseries",
          "title": "Requêtes HTTP par seconde",
          "targets": [
            { "expr": "rate(django_http_requests_total[1m])", "legendFormat": "Req/s" }
          ],
          "gridPos": { "x": 0, "y": 0, "w": 12, "h": 6 }
        },
        {
          "type": "timeseries",
          "title": "Temps de réponse moyen (s)",
          "targets": [
            { "expr": "rate(django_http_response_time_seconds_sum[5m]) / rate(django_http_response_time_seconds_count[5m])", "legendFormat": "Temps moyen" }
          ],
          "gridPos": { "x": 0, "y": 6, "w": 12, "h": 6 }
        },
        {
          "type": "stat",
          "title": "Erreurs 500",
          "targets": [
            { "expr": "sum(increase(django_http_responses_total{status='500'}[5m]))" }
          ],
          "gridPos": { "x": 12, "y": 0, "w": 6, "h": 6 }
        }
      ]
    }

  mysql-dashboard.json: |
    {
      "title": "Surveillance MySQL",
      "uid": "mysql-dashboard",
      "schemaVersion": 30,
      "panels": [
        {
          "type": "stat",
          "title": "Connexions actives",
          "targets": [
            { "expr": "mysql_global_status_threads_connected" }
          ],
          "gridPos": { "x": 0, "y": 0, "w": 6, "h": 6 }
        },
        {
          "type": "timeseries",
          "title": "Requêtes par seconde",
          "targets": [
            { "expr": "rate(mysql_global_status_queries[1m])", "legendFormat": "QPS" }
          ],
          "gridPos": { "x": 6, "y": 0, "w": 12, "h": 6 }
        },
        {
          "type": "gauge",
          "title": "Buffer Pool Utilisation (%)",
          "targets": [
            { "expr": "(mysql_global_status_buffer_pool_bytes_data / mysql_global_status_buffer_pool_bytes_total) * 100" }
          ],
          "gridPos": { "x": 0, "y": 6, "w": 6, "h": 6 }
        }
      ]
    }

  kube-state-dashboard.json: |
    {
      "title": "Surveillance Kube-State Metrics",
      "uid": "kube-dashboard",
      "schemaVersion": 30,
      "panels": [
        {
          "type": "bargauge",
          "title": "Pods non disponibles",
          "targets": [
            { "expr": "sum(kube_deployment_status_replicas_unavailable)" }
          ],
          "gridPos": { "x": 0, "y": 0, "w": 12, "h": 6 }
        },
        {
          "type": "stat",
          "title": "Nombre total de déploiements",
          "targets": [
            { "expr": "count(kube_deployment_created)" }
          ],
          "gridPos": { "x": 0, "y": 6, "w": 6, "h": 6 }
        },
        {
          "type": "timeseries",
          "title": "Pods en état Running",
          "targets": [
            { "expr": "count(kube_pod_status_phase{phase='Running'})" }
          ],
          "gridPos": { "x": 6, "y": 6, "w": 12, "h": 6 }
        }
      ]
    }

  node-exporter-dashboard.json: |
    {
      "title": "Surveillance Système (Node Exporter)",
      "uid": "node-dashboard",
      "schemaVersion": 30,
      "panels": [
        {
          "type": "gauge",
          "title": "Utilisation CPU (%)",
          "targets": [
            { "expr": "100 - (avg by (instance)(rate(node_cpu_seconds_total{mode='idle'}[5m])) * 100)" }
          ],
          "gridPos": { "x": 0, "y": 0, "w": 6, "h": 6 }
        },
        {
          "type": "gauge",
          "title": "Mémoire utilisée (%)",
          "targets": [
            { "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100" }
          ],
          "gridPos": { "x": 6, "y": 0, "w": 6, "h": 6 }
        },
        {
          "type": "gauge",
          "title": "Utilisation Disque (%)",
          "targets": [
            { "expr": "(1 - (node_filesystem_avail_bytes{mountpoint='/'} / node_filesystem_size_bytes{mountpoint='/'})) * 100" }
          ],
          "gridPos": { "x": 12, "y": 0, "w": 6, "h": 6 }
        }
      ]
    }
